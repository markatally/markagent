generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String?      @map("password_hash")
  googleId     String?      @unique @map("google_id")
  displayName  String?      @map("display_name")
  createdAt    DateTime     @default(now()) @map("created_at")

  sessions     Session[]
  apiKeys      ApiKey[]
  feedback     Feedback[]
  oauthAccounts OAuthAccount[]
  externalSkills UserExternalSkill[]
  externalSkillExecutions ExternalSkillExecution[]

  @@map("users")
}

model OAuthAccount {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  provider     String   // 'google', 'github', etc.
  providerId   String   @map("provider_id") // Provider's user ID
  accessToken  String?  @map("access_token")
  refreshToken String?  @map("refresh_token")
  expiresAt    DateTime? @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_accounts")
}

model Session {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  name          String?
  workspacePath String?   @map("workspace_path")
  createdAt     DateTime  @default(now()) @map("created_at")
  lastActiveAt  DateTime  @default(now()) @map("last_active_at")
  status        String    @default("active")

  user          User      @relation(fields: [userId], references: [id])
  messages      Message[]
  toolCalls     ToolCall[]
  files         File[]

  @@index([userId])
  @@index([status])
  @@index([lastActiveAt(sort: Desc)])
  @@map("sessions")
}

model Message {
  id        String    @id @default(uuid())
  sessionId String    @map("session_id")
  role      String
  content   String
  metadata  Json?
  createdAt DateTime  @default(now()) @map("created_at")

  session   Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  toolCalls ToolCall[]
  feedback  Feedback[]

  @@index([sessionId])
  @@index([createdAt(sort: Desc)])
  @@map("messages")
}

model ToolCall {
  id         String    @id @default(uuid())
  sessionId  String    @map("session_id")
  messageId  String?   @map("message_id")
  toolName   String    @map("tool_name")
  parameters Json
  result     Json?
  status     String
  durationMs Int?      @map("duration_ms")
  createdAt  DateTime  @default(now()) @map("created_at")

  session    Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  message    Message?  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([messageId])
  @@index([status])
  @@map("tool_calls")
}

model File {
  id        String    @id @default(uuid())
  sessionId String    @map("session_id")
  filename  String
  filepath  String
  sizeBytes BigInt?   @map("size_bytes")
  mimeType  String?   @map("mime_type")
  createdAt DateTime  @default(now()) @map("created_at")

  session   Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("files")
}

model ApiKey {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  service      String
  encryptedKey String    @map("encrypted_key")
  createdAt    DateTime  @default(now()) @map("created_at")

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, service])
  @@map("api_keys")
}

model Feedback {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  messageId String    @map("message_id")
  rating    Int
  comment   String?
  createdAt DateTime  @default(now()) @map("created_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@map("feedback")
}

model ExternalSkill {
  id                String              @id @default(cuid())
  canonicalId       String              @unique @map("canonical_id")
  name              String
  description       String
  version           String
  contractVersion   String?             @map("contract_version")
  status            SkillStatus         @default(ACTIVE)
  lifecycleStatus   String?             @map("lifecycle_status")
  reviewedAt        DateTime?           @map("reviewed_at")
  category          String?
  inputSchema       Json?               @map("input_schema")
  outputSchema      Json?               @map("output_schema")
  invocationPattern String?             @map("invocation_pattern")
  dependencies      String[]
  filePath          String              @map("file_path")

  capabilityLevel   CapabilityLevel     @default(EXTERNAL) @map("capability_level")
  runtimeVersion    String?             @map("runtime_version")
  executionScope    ExecutionScope      @default(AGENT) @map("execution_scope")

  sources           ExternalSkillSource[]
  mergedFrom        String[]            @map("merged_from")
  userSkills        UserExternalSkill[]
  executions        ExternalSkillExecution[]

  isProtected       Boolean             @default(false) @map("is_protected")
  protectionReason  String?             @map("protection_reason")

  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  @@index([category])
  @@index([status])
  @@index([capabilityLevel])
  @@map("external_skills")
}

model UserExternalSkill {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  canonicalId  String   @map("canonical_id")
  enabled      Boolean  @default(true)
  customConfig Json?    @map("custom_config")
  enabledAt    DateTime @default(now()) @map("enabled_at")
  disabledAt   DateTime? @map("disabled_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill        ExternalSkill @relation(fields: [canonicalId], references: [canonicalId], onDelete: Cascade)

  @@unique([userId, canonicalId])
  @@index([userId])
  @@index([canonicalId])
  @@map("user_external_skills")
}

model ExternalSkillExecution {
  id                String   @id @default(cuid())
  canonicalId       String   @map("canonical_id")
  userId            String?  @map("user_id")
  sessionId         String?  @map("session_id")
  traceId           String   @map("trace_id")
  parentExecutionId String?  @map("parent_execution_id")
  input             Json
  parameters        Json     @default("{}")
  output            Json?
  status            String
  errorType         String?  @map("error_type")
  errorMessage      String?  @map("error_message")
  executionTimeMs   Int?     @map("execution_time_ms")
  tokensUsed        Int?     @map("tokens_used")
  toolsUsed         String[] @map("tools_used")
  policySnapshot    Json?    @map("policy_snapshot")
  startedAt         DateTime @default(now()) @map("started_at")
  completedAt       DateTime? @map("completed_at")
  createdAt         DateTime @default(now()) @map("created_at")

  skill             ExternalSkill @relation(fields: [canonicalId], references: [canonicalId])
  user              User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt(sort: Desc)])
  @@index([canonicalId, createdAt(sort: Desc)])
  @@index([status])
  @@index([traceId])
  @@index([sessionId])
  @@map("external_skill_executions")
}

model ExternalSkillSource {
  id         String        @id @default(cuid())
  skillId    String        @map("skill_id")
  skill      ExternalSkill @relation(fields: [skillId], references: [id], onDelete: Restrict)
  repoUrl    String        @map("repo_url")
  repoPath   String        @map("repo_path")
  commitHash String?       @map("commit_hash")
  license    String?
  syncedAt   DateTime      @default(now()) @map("synced_at")

  @@unique([skillId, repoUrl, repoPath])
  @@map("external_skill_sources")
}

enum SkillStatus {
  ACTIVE
  EXTENDED
  DEPRECATED
  PROTECTED
}

enum CapabilityLevel {
  EXTERNAL
  INTERNAL
  PRODUCT
}

enum ExecutionScope {
  SYSTEM
  AGENT
  USER_VISIBLE
}
